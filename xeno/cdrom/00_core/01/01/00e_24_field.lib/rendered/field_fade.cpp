////////////////////////////////
// field_fade_init()

id = A0;

A0 = 800b1598 + id * 58 + 18;
system_graphic_monochrome_rectangle_header();

A0 = 800b1598 + id * 58 + 18;
A1 = 1;
system_psyq_set_semi_trans();

[800b1598 + id * 58 + 18 + 8] = h(0);   // x
[800b1598 + id * 58 + 18 + a] = h(0);   // y
[800b1598 + id * 58 + 18 + c] = h(140); // w
[800b1598 + id * 58 + 18 + e] = h(e0);  // h

// copy for second buffer
[800b1598 + id * 58 + 18 + 10] = w(w[800b1598 + id * 58 + 18 + 0]);
[800b1598 + id * 58 + 18 + 14] = w(w[800b1598 + id * 58 + 18 + 4]);
[800b1598 + id * 58 + 18 + 18] = w(w[800b1598 + id * 58 + 18 + 8]);
[800b1598 + id * 58 + 18 + 1c] = w(w[800b1598 + id * 58 + 18 + c]);

[800b1598 + id * 58 + 38] = w(0); // r
[800b1598 + id * 58 + 3c] = w(0); // g
[800b1598 + id * 58 + 40] = w(0); // b

[800b1598 + id * 58 + 50] = h(2); // semi_tr
[800b1598 + id * 58 + 52] = h(0); // is render
[800b1598 + id * 58 + 54] = h(0); // steps
////////////////////////////////



////////////////////////////////
// field_fade_add_to_render()

otag = A0;
rb = A1;

for( int i = 0; i < 2; ++i )
{
    if( h[800b1598 + i * 58 + 52] != 0 )
    {
        [800af310 + i * 8 + 0] = h(0);
        [800af310 + i * 8 + 2] = h(0);
        [800af310 + i * 8 + 4] = h(140);
        [800af310 + i * 8 + 6] = h(e0);

        A0 = 0;
        A1 = h[800b1598 + i * 58 + 50]; // semi_tr
        A2 = 0;
        A3 = 0;
        system_graphic_get_texpage_by_param();

        S0 = 800b1598 + i * 58 + rb * c;

        A0 = S0;
        A1 = 0;
        A2 = 0;
        A3 = V0 & ffff;
        A4 = 800af310 + i * 8;
        system_gpu_create_texture_setting_packet();

        A0 = (i ^ 1) < 1;
        A0 = otag + A0 * 4;

        A1 = 800b1598 + i * 58 + 18 + rb * 10;
        [A1 + 4] = b(w[800b1598 + i * 58 + 38] >> 8); // r
        [A1 + 5] = b(w[800b1598 + i * 58 + 3c] >> 8); // g
        [A1 + 6] = b(w[800b1598 + i * 58 + 40] >> 8); // b

        [A1] = w((w[A1] & ff000000) | (w[A0] & 00ffffff));
        [A0] = w((w[A0] & ff000000) | (A1 & 00ffffff));

        A1 = 800b1598 + i * 58 + rb * c;
        [A1] = w((w[A1] & ff000000) | (V1 & 00ffffff));
        [A0] = w((w[A0] & ff000000) | (S0 & 00ffffff));

        if( ( w[800b1598 + i * 58 + 38] >> 8 ) == 0 )
        {
            if( ( w[800b1598 + i * 58 + 3c] >> 8 ) == 0 )
            {
                if( ( w[800b1598 + i * 58 + 40] >> 8 ) == 0 )
                {
                    [800b1598 + i * 58 + 52] = h(0);
                    [800b1598 + i * 58 + 54] = h(0);
                }
            }
        }
    }
}
////////////////////////////////



////////////////////////////////
// field_fade_both_init()

A0 = 0;
field_fade_init();

A0 = 1;
field_fade_init();
////////////////////////////////



////////////////////////////////
// field_fade_update()

if( h[800b1598 + A0 * 58 + 52] == 0 ) // if not rendered
{
    return;
}

if( h[800b1598 + A0 * 58 + 54] <= 0 )
{
    [800b1598 + A0 * 58 + 54] = h(0);

    if( ( h[800ad0e0] != 1 ) && ( w[800b1598 + A0 * 58 + 38] == 0 ) && ( w[800b1598 + A0 * 58 + 3c] == 0 ) && ( w[800b1598 + A0 * 58 + 40] == 0 ) )
    {
        [800b1598 + A0 * 58 + 52] = h(0); // stop render
    }
}
else
{
    // increase r
    [800b1598 + A0 * 58 + 38] = w(w[800b1598 + A0 * 58 + 38] + w[800b1598 + A0 * 58 + 44]);
    if( ( w[800b1598 + A0 * 58 + 38] >> 8 ) >= 100 ) [800b1598 + A0 * 58 + 38] = w(ff00);
    if( w[800b1598 + A0 * 58 + 38] < 0 )             [800b1598 + A0 * 58 + 38] = w(0);

    // increase g
    [800b1598 + A0 * 58 + 3c] = w(w[800b1598 + A0 * 58 + 3c] + w[800b1598 + A0 * 58 + 48]);
    if( ( w[800b1598 + A0 * 58 + 3c] >> 8 ) >= 100 ) [800b1598 + A0 * 58 + 3c] = w(ff00);
    if( w[800b1598 + A0 * 58 + 3c] < 0 )             [800b1598 + A0 * 58 + 3c] = w(0);

    // increase b
    [800b1598 + A0 * 58 + 40] = w(w[800b1598 + A0 * 58 + 40] + w[800b1598 + A0 * 58 + 4c]);
    if( ( w[800b1598 + A0 * 58 + 40] >> 8 ) >= 100 ) [800b1598 + A0 * 58 + 40] = w(ff00);
    if( w[800b1598 + A0 * 58 + 40] < 0 )             [800b1598 + A0 * 58 + 40] = w(0);

    [800b1598 + A0 * 58 + 54] = h(hu[800b1598 + A0 * 58 + 54] - 1);
}
////////////////////////////////



////////////////////////////////
// field_fade_update_and_add_to_render()

otag = A0;

if( w[800ad0dc] == 2 )
{
    A0 = 0;
    field_fade_update();

    A0 = 1;
    field_fade_update();
}

A0 = otag;
A1 = w[800acfe0]; // rb
field_fade_add_to_render();
////////////////////////////////



////////////////////////////////
// field_fade_setup()

id = A0;
steps = A1;
r = A2;
g = A3;
b = A4;
semi_tr = A5;

// set step color change from current value
[800b1598 + id * 58 + 44] = w(((r << 8) - w[800b1598 + id * 58 + 38]) / steps);
[800b1598 + id * 58 + 48] = w(((g << 8) - w[800b1598 + id * 58 + 3c]) / steps);
[800b1598 + id * 58 + 4c] = w(((b << 8) - w[800b1598 + id * 58 + 40]) / steps);

[800b1598 + id * 58 + 50] = h(semi_tr);
[800b1598 + id * 58 + 52] = h(1);
[800b1598 + id * 58 + 54] = h(steps);
////////////////////////////////



////////////////////////////////
// field_fade_set_fadeout()
// set fade from transparent to black

steps = A0;

if( h[800ad0e0] != 1 )
{
    [800ad0e0] = h(1);

    if( w[800ad0dc] == 1 )
    {
        [800b1598 + 38] = w(0);
        [800b1598 + 3c] = w(0);
        [800b1598 + 40] = w(0);
        [800b1598 + 44] = w(ff00 / steps);
        [800b1598 + 48] = w(ff00 / steps);
        [800b1598 + 4c] = w(ff00 / steps);
        [800b1598 + 50] = h(2); // semi_tr
        [800b1598 + 52] = h(1);
        [800b1598 + 54] = h(steps);
    }
}
////////////////////////////////



////////////////////////////////
// field_fade_set_fadein()
// set fade from black to transparent

steps = A0;

if( h[800ad0e0] != 0 )
{
    [800ad0e0] = h(0);

    if( w[800ad0dc] == 1 )
    {
        [800b1598 + 38] = w(ff00);
        [800b1598 + 3c] = w(ff00);
        [800b1598 + 40] = w(ff00);
        [800b1598 + 44] = w(ffff0000 / steps);
        [800b1598 + 48] = w(ffff0000 / steps);
        [800b1598 + 4c] = w(ffff0000 / steps);
        [800b1598 + 50] = h(2);
        [800b1598 + 52] = h(1);
        [800b1598 + 54] = h(steps);
    }
}
////////////////////////////////



////////////////////////////////
// field_fade_whitein()
// set fade from white to transparent

steps = A0;

[800b1598 + 38] = w(0000ff00);
[800b1598 + 3c] = w(0000ff00);
[800b1598 + 40] = w(0000ff00);
[800b1598 + 44] = w(-10000 / steps);
[800b1598 + 48] = w(-10000 / steps);
[800b1598 + 4c] = w(-10000 / steps);
[800b1598 + 50] = h(1);
[800b1598 + 52] = h(1);
[800b1598 + 54] = h(steps + 1);
////////////////////////////////



////////////////////////////////
// field_fade_whiteout()
// set fade from transparent to white

steps = A0;

[800b1598 + 38] = w(0);
[800b1598 + 3c] = w(0);
[800b1598 + 40] = w(0);
[800b1598 + 44] = w(10000 / steps);
[800b1598 + 48] = w(10000 / steps);
[800b1598 + 4c] = w(10000 / steps);
[800b1598 + 50] = h(1);
[800b1598 + 52] = h(1);
[800b1598 + 54] = h(steps + 1);
////////////////////////////////